// SPDX-License-Identifier: MIT
// Code for teaching purposes only.
// See University of Basel cryptolectures.io

pragma solidity ^0.8.9;

contract ExploitableCoinFlip {
    // Heads = 0, Tails = 1
    enum Choice { Heads, Tails }

    event FlipPlayed(address indexed player, Choice guess, Choice result, uint256 wager, bool win);

    // Anyone can fund the contract so it can pay winners
    receive() external payable {}

    // Flip a coin by guessing Heads or Tails and sending ETH as a wager.
    // If correct, the player receives 2x the sent ETH. If not, the contract keeps the ETH.
    function flip(Choice guess) external payable {
        require(msg.value > 0, "Wager must be > 0");

        // Pseudo-randomness (insecure by design, easy to exploit. For teaching purposes only!)
        uint256 r = uint256(
            keccak256(
                abi.encodePacked(
                    blockhash(block.number - 1),
                    block.timestamp,
                    msg.sender
                )
            )
        );
        Choice result = Choice(r % 2);

        bool win = (result == guess);

        if (win) {
            uint256 payout = msg.value * 2;
            require(address(this).balance >= payout, "Contract underfunded");
            (bool ok, ) = msg.sender.call{value: payout}("");
            require(ok, "ETH transfer failed");
        }

        emit FlipPlayed(msg.sender, guess, result, msg.value, win);
    }

    // Helper view to preview the current contract balance (house bankroll)
    function bankroll() external view returns (uint256) {
        return address(this).balance;
    }
}
